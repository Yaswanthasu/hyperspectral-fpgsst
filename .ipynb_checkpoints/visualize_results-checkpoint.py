# ---
# jupyter:
#   jupytext:
#     text_representation:
#       extension: .py
#       format_name: light
#       format_version: '1.5'
#       jupytext_version: 1.15.1
#   kernelspec:
#     display_name: Python 3 (ipykernel)
#     language: python
#     name: python3
# ---

# +
# #!/usr/bin/env python3
"""
visualize_results.py
--------------------
Visualize full predicted maps generated by save_pred_map_full.py.
It overlays predictions and ground truth for PaviaU, Loukia, and WHU_Hi_LongKou.
"""

import os
import numpy as np
import matplotlib.pyplot as plt
from scipy.io import loadmat

plt.rcParams["figure.dpi"] = 150
COLORMAP = plt.get_cmap('tab20')

def visualize_full(pred_path, gt_path, dataset, out_dir="results"):
    pred_data = loadmat(pred_path)
    gt_data = loadmat(gt_path)

    pred = pred_data.get("pred_map")
    if pred is None:
        raise ValueError(f"No 'pred_map' found in {pred_path}")
    pred = np.squeeze(pred)

    # Find GT array key
    gt = None
    for k in gt_data.keys():
        if not k.startswith("__"):
            gt = gt_data[k]
            break
    if gt is None:
        raise ValueError(f"No ground truth found in {gt_path}")

    # Ensure matching shapes
    H, W = gt.shape
    if pred.shape != (H, W):
        pred = pred[:H, :W]  # crop if needed
    print(f"{dataset}: pred shape {pred.shape}, gt shape {gt.shape}")

    # Plot
    fig, axes = plt.subplots(1, 2, figsize=(10, 4))
    im0 = axes[0].imshow(gt, cmap=COLORMAP)
    axes[0].set_title(f"{dataset} - Ground Truth")
    axes[0].axis("off")

    im1 = axes[1].imshow(pred, cmap=COLORMAP)
    axes[1].set_title(f"{dataset} - FPGSST Prediction")
    axes[1].axis("off")

    os.makedirs(out_dir, exist_ok=True)
    out_path = os.path.join(out_dir, f"{dataset}_visualization.png")
    plt.tight_layout()
    plt.savefig(out_path, dpi=300)
    plt.close()
    print(f"‚úÖ Saved visualization: {out_path}")


def main():
    datasets = {
        "PaviaU": {
            "pred": "results/pred_map_PaviaU.mat",
            "gt": "datasets/PaviaU/PaviaU_gt.mat",
        },
        "Loukia": {
            "pred": "results/pred_map_Loukia.mat",
            "gt": "datasets/HyRANK/Loukia_gt.mat",
        },
        "WHU_Hi_LongKou": {
            "pred": "results/pred_map_WHU_Hi_LongKou.mat",
            "gt": "datasets/WHU_Hi/WHU_Hi_LongKou_gt.mat",
        },
    }

    for name, paths in datasets.items():
        try:
            print(f"üìÇ Visualizing dataset: {name}")
            visualize_full(paths["pred"], paths["gt"], name)
        except Exception as e:
            print(f"‚ùå Error visualizing {name}: {e}")


if __name__ == "__main__":
    main()

